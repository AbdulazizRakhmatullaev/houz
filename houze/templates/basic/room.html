{% extends 'base.html' %}

{% block title %} Home {% endblock %}

{% block content %}
<div class="room-title">
    <div class="brief-left-info">
        <div class="detailed-ci-cy">
            {{ room.get_city_display }}, Uzbekistan
        </div>
        <div class="brief-name">
            {{ room.title }}
        </div>
        <div class="howmany">
            {{room.how_many|safe}} <span class="spr">•</span>
            {{room.room_type_set.all}}
        </div>
    </div>
    <div class="brief-right-info">
        {% if room.average_rating >= 4.0 %}
        <div class="brief-info-col-itm">
            <div class="briefmsg">
                Most people recommend this place!
            </div>
        </div>
        {% endif %}
        <a href="#room-reviews-content" class="brief-info-col-itm">
            {{room.average_rating}} ({{room.rating_set.count}})
            <div class="r-stars">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false" style="display: block; height: 12px; width: 12px; fill: currentcolor;">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false" style="display: block; height: 12px; width: 12px; fill: currentcolor;">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false" style="display: block; height: 12px; width: 12px; fill: currentcolor;">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false" style="display: block; height: 12px; width: 12px; fill: currentcolor;">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false" style="display: block; height: 12px; width: 12px; fill: currentcolor;">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
            </div>
        </a>
    </div>
</div>
<div class="fl-spbn">
    <div class="left-info-column">
        <!-- Your HTML template -->
        <div id="myCarousel" class="carousel">
            <!-- Wrapper for slides -->
            <div class="carousel-inner">
                {% for photo in room.all_photos %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{photo.file.url}}" alt="" class="each-image">
                </div>
                {% endfor %}
            </div>

            <!-- Left and right controls -->
            {% if room.all_photos|length > 1 %}
            <span class="carousel-control-prev" role="button" onclick="prevSlide()">
                <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="m15.8839 18.1161c.4881.4882.4881 1.2796 0 1.7678-.4882.4881-1.2796.4881-1.7678 0l-6.99998-7c-.48816-.4882-.48816-1.2796 0-1.7678l6.99998-6.99998c.4882-.48816 1.2796-.48816 1.7678 0 .4881.48815.4881 1.27961 0 1.76776l-6.11613 6.11612z"
                        fill="currentColor" />
                </svg>
            </span>
            <span class="carousel-control-next" role="button" onclick="nextSlide()">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="m14.2322 12-6.11608-6.11612c-.48816-.48815-.48816-1.27961 0-1.76776.48815-.48816 1.27961-.48816 1.76776 0l7.00002 6.99998c.4881.4882.4881 1.2796 0 1.7678l-7.00002 7c-.48815.4881-1.27961.4881-1.76776 0-.48816-.4882-.48816-1.2796 0-1.7678z"
                        fill="currentColor" />
                </svg>
            </span>
            {% endif %}
        </div>
        <div class="info-title">Host</div>
        <div class="host-info coll">
            <a href="{% url 'user_profile' room.host.username %}">
                {% if room.host.profile.avatar.url != null %}
                <img src="{{room.host.profile.avatar.url}}" alt="" class="detpp">
                {% else %}
                <div class="detpp" style="background: linear-gradient({{room.host.profile.avatar_default}});">
                    <div class="detgrcn">
                        {{room.host.profile.name|slice:"0:1"}}
                    </div>
                </div>
                {% endif %}
            </a>
            <div class="n-d">
                <a href="{% url 'user_profile' room.host.username %}" class="host-name">
                    {{room.host.profile.name}}
                </a>
                <div class="host-date">
                    Joinded {{room.host.profile.created_at|date:"N Y"}}
                </div>
            </div>
        </div>
        <div class="info-title">Description</div>
        <div class="desc info-col">
            {{room.description}}
        </div>
        <div class="info-title">Amenities</div>
        <div class="amenities-col">
            {% for amenity in room.amenities.all %}
            <div class="amenity">
                {{amenity}}
            </div>
            {% endfor %}
        </div>
        <div class="info-title">House rules</div>
        <div class="hrule-col">
            {% for rule in room.house_rules.all %}
            <div class="hrule">
                {{rule}}
            </div>
            {% endfor %}
        </div>
        <div>
            <input type="hidden" id="latitude" name="latitude" value="{{room.fst_loc}}">
            <input type="hidden" id="longitude" name="longitude" value="{{room.sec_loc}}">
        </div>
        <div class="info-title">Address</div>
        <div class="coll">
            {{room.address}}
        </div>
        <div class="info-title">Where it's located</div>
        <div id="roomMap" class="room-location"></div>
        <div class="info-title">Reviews</div>
        <div id="room-reviews-content">
            {% for review in reviews %}
            <div class="review">
                <a href="{% url 'user_profile' review.user.username %}">
                    {% if review.user.profile.avatar.url != null %}
                    <img src="{{review.user.profile.avatar.url}}" alt="" class="pp">
                    {% else %}
                    <div class="pp" style="background: linear-gradient({{review.user.profile.avatar_default}});">
                        <div class="grcn">
                            {{review.user.profile.name|slice:"0:1"}}
                        </div>
                    </div>
                    {% endif %}
                </a>
                <div class="n-d">
                    <div class="n-stayed">
                        <a href="{% url 'user_profile' review.user.username %}"
                            class="reviewer-name">{{review.user.profile.name}}</a>
                        <div class="spr">•</div>
                        <div class="review-date">{{review.get_date}}</div>
                    </div>
                    <!--  -->
                    <div class="r-stars">
                        {{review.user_ratings|safe}}
                    </div>
                    <div class="review-text">{{review.review_text}}</div>
                </div>
            </div>
            {% empty %}
            <div class="infotxt">No reviews yet...</div>
            {% endfor %}
        </div>
    </div>
    <div class="right-info-column">
        <div class="sticky-right-col">
            <div class="price-info">
                <span class="room-price">From UZS {{room.get_price}} night</span>
            </div>
            <form action="{% url 'book_room' room.id %}" method="post">
                {% csrf_token %}
                <div class="check-inNout">
                    <div class="check-io">
                        <span class="small-title">Check-in</span>
                        <input type="date" name="check_in" value='{{room.check_in|date:"Y-m-d"}}'
                            min='{{room.check_in|date:"Y-m-d"}}' max='{{room.check_out|date:"Y-m-d"}}'>
                    </div>
                    <div class="check-io">
                        <span class="small-title">Check-out</span>
                        <input type="date" name="check_out" value='{{room.check_out|date:"Y-m-d"}}'
                            min='{{room.check_in|date:"Y-m-d"}}' max='{{room.check_out|date:"Y-m-d"}}'>
                    </div>
                </div>
                <div class="payment">
                    <button class="btn" id="message-btn">Reserve it</button>
                </div>
            </form>
            <div class="payment">
                <div class="pricing-col">
                    <div class="left-text">{{room.get_price}} soums x{{room.num_o_days}} nights</span></div>
                    <div class="right-text">{{room.count_nights_price}} soums</div>
                </div>
                <div class="pricing-col">
                    <div class="left-text">Uzrent fee</span></div>
                    <div class="right-text">{{room.fee}} soums</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block footer %}
{% endblock %}

{% block scripts %}
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JhY2tlZHBvb2wiLCJhIjoiY2x2YmZ4cHdzMDg3NDJpcDF2MHc4emkyYSJ9.BsOd8E2wuYCPzUMaNOsqBg';

    var initialLatitude = parseFloat(document.getElementById('latitude').value);
    var initialLongitude = parseFloat(document.getElementById('longitude').value);

    var roomMap = new mapboxgl.Map({
        container: 'roomMap',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [initialLongitude, initialLatitude], // Tashkent, Uzbekistan
        zoom: 13
    });

    // Add zoom and unzoom controls
    roomMap.addControl(new mapboxgl.NavigationControl());

    // Create marker
    var marker = new mapboxgl.Marker({
        draggable: false
    }).setLngLat([initialLongitude, initialLatitude]).addTo(roomMap);
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var bookedDates = {{ booked_dates| safe
    }};
    var checkInInput = document.querySelector('input[name="check_in"]');
    var checkOutInput = document.querySelector('input[name="check_out"]');

    function isDateBooked(dateString) {
        for (var i = 0; i < bookedDates.length; i++) {
            var startDate = new Date(bookedDates[i][0]);
            var endDate = new Date(bookedDates[i][1]);
            var currentDate = new Date(dateString);
            if (currentDate >= startDate && currentDate <= endDate) {
                return true;
            }
        }
        return false;
    }

    // Disable booked dates in the check-in input
    checkInInput.addEventListener('input', function () {
        var selectedDate = checkInInput.value;
        if (isDateBooked(selectedDate)) {
            checkInInput.setCustomValidity('This date is already booked.');
        } else {
            checkInInput.setCustomValidity('');
        }
    });

    // Disable booked dates in the check-out input
    checkOutInput.addEventListener('input', function () {
        var selectedDate = checkOutInput.value;
        if (isDateBooked(selectedDate)) {
            checkOutInput.setCustomValidity('This date is already booked.');
        } else {
            checkOutInput.setCustomValidity('');
        }
    });
    });
</script>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-item');
    const totalSlides = slides.length;
    const prevArrow = document.querySelector('.carousel-control-prev');
    const nextArrow = document.querySelector('.carousel-control-next');

    function showSlide(index) {
        slides[currentSlide].classList.remove('active');
        slides[index].classList.add('active');
        currentSlide = index;
        updateCarouselPosition();
        updateArrowVisibility();
    }

    function prevSlide() {
        let index = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(index);
    }

    function nextSlide() {
        let index = (currentSlide + 1) % totalSlides;
        showSlide(index);
    }

    function updateCarouselPosition() {
        const position = -currentSlide * 100;
        document.querySelector('.carousel-inner').style.transform = `translateX(${position}%)`;
    }

    function updateArrowVisibility() {
        if (currentSlide === 0) {
            prevArrow.style.display = 'none'; // Hide previous arrow when on the first slide
        } else {
            prevArrow.style.display = 'grid'; // Show previous arrow otherwise
        }
        if (currentSlide === totalSlides - 1) {
            nextArrow.style.display = 'none'; // Hide next arrow when on the last slide
        } else {
            nextArrow.style.display = 'grid'; // Show next arrow otherwise
        }
    }

    // Call updateArrowVisibility() once the page loads
    document.addEventListener("DOMContentLoaded", function () {
        updateArrowVisibility();
    });
</script>
{% endblock %}