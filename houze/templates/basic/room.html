{% extends 'base.html' %}

{% block title %} Home {% endblock %}

{% block content %}
<div class="room-title">
    <div class="brief-left-info">
        <div class="detailed-ci-cy">
            {{ room.get_city_display }}, Uzbekistan
        </div>
        <div class="brief-name">
            {{ room.title }}
        </div>
        <div class="howmany">
            {{room.how_many|safe}}
        </div>
    </div>
    <div class="brief-right-info">
        {% if room.average_rating >= 4.0 %}
        <div class="guestfav">
            <div class="briefmsg">
                Most people recommend this place!
            </div>
        </div>
        {% endif %}
        <a href="#room-reviews-content" class="brief-info-col-itm">
            {{room.average_rating}} ({{room.rating_set.count}})
            <div class="p-stars">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
            </div>
        </a>
    </div>
</div>
<div class="roomfl">
    <div class="left-info-column">
        <!-- Your HTML template -->
        <div id="myCarousel" class="carousel">
            <!-- Wrapper for slides -->
            <div class="carousel-inner">
                {% for photo in room.all_photos %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{photo.file.url}}" alt="" class="each-image">
                </div>
                {% endfor %}
            </div>

            <!-- Left and right controls -->
            {% if room.all_photos|length > 1 %}
            <span class="carousel-control-prev" role="button" onclick="prevSlide()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                    <path
                        d="M21.559,12.062 L15.618,17.984 L21.5221,23.944 C22.105,24.533 22.1021,25.482 21.5131,26.065 C21.2211,26.355 20.8391,26.4999987 20.4571,26.4999987 C20.0711,26.4999987 19.6851,26.352 19.3921,26.056 L12.4351,19.034 C11.8531,18.446 11.8551,17.4999987 12.4411,16.916 L19.4411,9.938 C20.0261,9.353 20.9781,9.354 21.5621,9.941 C22.1471,10.528 22.1451,11.478 21.5591,12.062 L21.559,12.062 Z">
                    </path>
                </svg>
            </span>
            <span class="carousel-control-next" role="button" onclick="nextSlide()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36">
                    <path
                        d="M23.5587,16.916 C24.1447,17.4999987 24.1467,18.446 23.5647,19.034 L16.6077,26.056 C16.3147,26.352 15.9287,26.4999987 15.5427,26.4999987 C15.1607,26.4999987 14.7787,26.355 14.4867,26.065 C13.8977,25.482 13.8947,24.533 14.4777,23.944 L20.3818,17.984 L14.4408,12.062 C13.8548,11.478 13.8528,10.5279 14.4378,9.941 C15.0218,9.354 15.9738,9.353 16.5588,9.938 L23.5588,16.916 L23.5587,16.916 Z">
                    </path>
                </svg>
            </span>
            {% endif %}
        </div>
        <div class="lbld">
            <div class="lbl0">Host</div>
            <div class="host-info">
                <a href="{% url 'user_profile' room.host.username %}">
                    {% if room.host.profile.avatar.url != null %}
                    <img src="{{room.host.profile.avatar.url}}" alt="" class="detpp">
                    {% else %}
                    <div class="detpp" style="background: linear-gradient({{room.host.profile.avatar_default}});">
                        <div class="detgrcn">
                            {{room.host.profile.name|slice:"0:1"}}
                        </div>
                    </div>
                    {% endif %}
                </a>
                <div class="n-d">
                    <a href="{% url 'user_profile' room.host.username %}" class="host-name">
                        {{room.host.profile.name}}
                    </a>
                    <div class="host-date">
                        Joinded {{room.host.profile.created_at|date:"N Y"}}
                    </div>
                </div>
            </div>
        </div>
        <div class="lbld">
            <div class="lbl0">Description</div>
            <div class="desc">
                {% if room.get_desc|length < 1500 %} {{room.get_desc}} {% else %} {{room.get_desc|slice:":1500"}}...
                    <div class="btnsubstart" style="margin-top: 10px;">
                    <button class="btn-white">See more...</button>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="lbld">
        <div class="lbl0">Amenities</div>
        <div class="amenities-col">
            {% for amenity in room.amenities.all %}
            <div class="amenity">
                {{amenity}}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="lbld">
        <div class="lbl0">House rules</div>
        <div class="hrule-col">
            {% for rule in room.house_rules.all %}
            <div class="hrule">
                {{rule}}
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="lbld">
        <div class="lbl0">Reviews</div>
        <div class="revsta">
            <div class="revsta-t">{{room.average_rating}}</div>
            <div class="rstars">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" aria-hidden="true" role="presentation"
                    focusable="false">
                    <path fill-rule="evenodd"
                        d="m15.1 1.58-4.13 8.88-9.86 1.27a1 1 0 0 0-.54 1.74l7.3 6.57-1.97 9.85a1 1 0 0 0 1.48 1.06l8.62-5 8.63 5a1 1 0 0 0 1.48-1.06l-1.97-9.85 7.3-6.57a1 1 0 0 0-.55-1.73l-9.86-1.28-4.12-8.88a1 1 0 0 0-1.82 0z">
                    </path>
                </svg>
            </div>
        </div>
        <div id="room-reviews-content">
            {% for review in reviews %}
            <div class="review">
                <a href="{% url 'user_profile' review.user.username %}">
                    {% if review.user.profile.avatar.url != null %}
                    <img src="{{review.user.profile.avatar.url}}" alt="" class="pp">
                    {% else %}
                    <div class="pp" style="background: linear-gradient({{review.user.profile.avatar_default}});">
                        <div class="grcn">
                            {{review.user.profile.name|slice:"0:1"}}
                        </div>
                    </div>
                    {% endif %}
                </a>
                <div class="n-d">
                    <div class="n-stayed">
                        <a href="{% url 'user_profile' review.user.username %}"
                            class="reviewer-name">{{review.user.profile.name}}</a>
                        <div class="spr">•</div>
                        <div class="review-date">{{review.get_date}}</div>
                    </div>
                    <!--  -->
                    <div class="r-stars">
                        {{review.user_ratings|safe}}
                    </div>
                    <div class="review-text">{{review.review_text}}</div>
                </div>
            </div>
            {% empty %}
            <div class="infotxt">No reviews yet.</div>
            {% endfor %}
        </div>
    </div>
    <div class="lbld">
        <div class="lbl0">Where it's located</div>
        <div class="collbsh">
            {{room.address}}, {{room.get_city_display}}, Uzbekistan
        </div>
        <input type="hidden" id="latitude" name="latitude" value="{{room.fst_loc}}">
        <input type="hidden" id="longitude" name="longitude" value="{{room.sec_loc}}">
        <div id="room_map" class="room-location"></div>
    </div>
</div>
<form action="{% url 'book_room' room.id %}" method="post" class="right-info-column">
    {% csrf_token %}
    <div class="htxt">How many people are there</div>
    <div class="check-io" style="margin-top: 13px;">
        <span class="small-title">Guests</span>
        <input type="guests" name="guests" value='1' min='1' max=''>
    </div>
    <div class="ahr"></div>
    <div class="htxt">When you want to stay</div>
    <div class="check-io" style="margin-top: 13px;">
        <span class="small-title">Check-in</span>
        <input type="date" name="check_in" value='{{room.check_in|date:"Y-m-d"}}' min='{{room.check_in|date:"Y-m-d"}}'
            max='{{room.check_out|date:"Y-m-d"}}'>
    </div>
    <div class="check-io">
        <span class="small-title">Check-out</span>
        <input type="date" name="check_out" value='{{room.check_out|date:"Y-m-d"}}' min='{{room.check_in|date:"Y-m-d"}}'
            max='{{room.check_out|date:"Y-m-d"}}'>
    </div>
    <div class="sticky-right-col">
        <div class="price-info">
            UZS
            <span id="total-price" class="room-price">{{room.tot_price}}</span>
        </div>
        <div class="actualprice">UZS <span id="actual-price">{{room.get_price}}</span>/night</div>
        <div class="ahr"></div>
        <div class="pricing-col">
            <div class="left-text">UZS {{room.get_price}} x <span id="num-nights">{{room.num_o_days}}</span> nights
            </div>
            <div class="right-text">UZS <span id="bynight-price">{{room.count_nights_price}}</span></div>
        </div>
        <div class="pricing-col" style="margin-top: 13px;">
            <div class="left-text">Houze fee</div>
            <div class="right-text">UZS <span id="houze-fee">{{room.fee}}</span></div>
        </div>
        <div class="payment">
            <button class="btn" id="message-btn">Reserve</button>
        </div>
    </div>
</form>
</div>

<div class="roomrecs">
    <div class="botmaint">There's always more to explore.</div>
    <div id="room-posts">
        {% include 'temps/room_list.html' %}
    </div>
</div>

{% endblock %}

{% block footer %}
{% endblock %}

{% block scripts %}
<script>
    // Helper function to calculate date difference in days
    function dateDiffInDays(date1, date2) {
        const diffTime = Math.abs(date2 - date1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }
    // Update prices and min/max attributes based on date input changes with animation
    function updatePrices() {
        const checkInInput = document.querySelector('input[name="check_in"]');
        const checkOutInput = document.querySelector('input[name="check_out"]');
        const checkInDate = new Date(checkInInput.value);
        const checkOutDate = new Date(checkOutInput.value);
        const actualPrice = parseFloat(document.getElementById('actual-price').textContent.replace(/,/g, ''));

        if (checkInDate && !isNaN(checkInDate.getTime())) {
            // Set check-out minimum date to the day after check-in
            const nextDay = new Date(checkInDate);
            nextDay.setDate(nextDay.getDate() + 1);
            checkOutInput.min = formatDate(nextDay);
        }

        if (checkOutDate && !isNaN(checkOutDate.getTime())) {
            // Set check-in maximum date to the day before check-out
            const prevDay = new Date(checkOutDate);
            prevDay.setDate(prevDay.getDate() - 1);
            checkInInput.max = formatDate(prevDay);
        }

        if (checkInDate && checkOutDate && checkOutDate > checkInDate) {
            const numNights = dateDiffInDays(checkInDate, checkOutDate);
            const bynightPrice = actualPrice * numNights;
            const fee = 0.33 * bynightPrice;
            const totalPrice = fee + bynightPrice;

            const numNightsElement = document.getElementById('num-nights');
            const bynightElement = document.getElementById('bynight-price');
            const totalPriceElement = document.getElementById('total-price');
            const feeElement = document.getElementById('houze-fee');

            function animateValue(element, start, end, duration) {
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    element.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }

            animateValue(numNightsElement, parseInt(numNightsElement.textContent), numNights, 800);
            animateValue(totalPriceElement, parseFloat(totalPriceElement.textContent.replace(/,/g, '')), totalPrice, 500);
            animateValue(bynightElement, parseFloat(bynightElement.textContent.replace(/,/g, '')), bynightPrice, 500);
            animateValue(feeElement, parseFloat(feeElement.textContent.replace(/,/g, '')), fee, 500);
        }
    }

    // Helper function to format date as "YYYY-MM-DD"
    function formatDate(date) {
        const year = date.getFullYear();
        let month = date.getMonth() + 1;
        if (month < 10) {
            month = '0' + month;
        }
        let day = date.getDate();
        if (day < 10) {
            day = '0' + day;
        }
        return `${year}-${month}-${day}`;
    }

    // Add event listeners to date inputs
    document.querySelector('input[name="check_in"]').addEventListener('change', updatePrices);
    document.querySelector('input[name="check_out"]').addEventListener('change', updatePrices);

    // Initial call to update prices on page load
    updatePrices();
</script>
<!-- <script>
    // Helper function to calculate date difference in days
    function dateDiffInDays(date1, date2) {
        const diffTime = Math.abs(date2 - date1);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    // Update prices with animation
    function updatePrices() {
        const checkInDate = new Date(document.querySelector('input[name="check_in"]').value);
        const checkOutDate = new Date(document.querySelector('input[name="check_out"]').value);
        const actualPrice = parseFloat(document.getElementById('actual-price').textContent.replace(/,/g, ''));

        if (checkInDate && checkOutDate && checkOutDate > checkInDate) {
            const numNights = dateDiffInDays(checkInDate, checkOutDate);
            const totalPrice = actualPrice * numNights;
            const fee = 0.33 * totalPrice;

            animateValue(document.getElementById('num-nights'), numNights);
            animateValue(document.getElementById('total-price'), totalPrice);
            animateValue(document.getElementById('houze-fee'), Math.round(fee)); // Round the fee
        }
    }

    // // Function to animate the value change
    // function animateValue(element, newValue) {
    //     const start = parseFloat(element.textContent.replace(/,/g, ''));
    //     const end = newValue;
    //     const duration = 500; // duration in ms
    //     const range = end - start;
    //     const increment = range / (duration / 10);
    //     let current = start;
    //     const stepTime = 10; // step time in ms

    //     function step() {
    //         if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
    //             element.textContent = end.toLocaleString(); // Ensure final value is set correctly
    //         } else {
    //             current += increment;
    //             element.textContent = Math.round(current).toLocaleString(); // Round and update text content
    //             // setTimeout(step, stepTime);
    //         }
    //     }

    //     step(); // Start the animation
    // }

    // Add event listeners to date inputs
    document.querySelector('input[name="check_in"]').addEventListener('change', updatePrices);
    document.querySelector('input[name="check_out"]').addEventListener('change', updatePrices);

    // Initial call to update prices on page load
    document.addEventListener('DOMContentLoaded', (event) => {
        updatePrices();
    });
</script> -->
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JhY2tlZHBvb2wiLCJhIjoiY2x2YmZ4cHdzMDg3NDJpcDF2MHc4emkyYSJ9.BsOd8E2wuYCPzUMaNOsqBg';

    var initialLatitude = parseFloat(document.getElementById('latitude').value);
    var initialLongitude = parseFloat(document.getElementById('longitude').value);

    var room_map = new mapboxgl.Map({
        container: 'room_map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [initialLongitude, initialLatitude], // Tashkent, Uzbekistan
        zoom: 13
    });

    // Add zoom and unzoom controls
    room_map.addControl(new mapboxgl.NavigationControl());

    // Create marker
    var marker = new mapboxgl.Marker({
        draggable: false
    }).setLngLat([initialLongitude, initialLatitude]).addTo(room_map);

</script>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-item');
    const totalSlides = slides.length;
    const prevArrow = document.querySelector('.carousel-control-prev');
    const nextArrow = document.querySelector('.carousel-control-next');

    function showSlide(index) {
        slides[currentSlide].classList.remove('active');
        slides[index].classList.add('active');
        currentSlide = index;
        updateCarouselPosition();
        updateArrowVisibility();
    }

    function prevSlide() {
        let index = (currentSlide - 1 + totalSlides) % totalSlides;
        showSlide(index);
    }

    function nextSlide() {
        let index = (currentSlide + 1) % totalSlides;
        showSlide(index);
    }

    function updateCarouselPosition() {
        const position = -currentSlide * 100;
        document.querySelector('.carousel-inner').style.transform = `translateX(${position}%)`;
    }

    function updateArrowVisibility() {
        if (currentSlide === 0) {
            prevArrow.style.display = 'none'; // Hide previous arrow when on the first slide
        } else {
            prevArrow.style.display = 'grid'; // Show previous arrow otherwise
        }
        if (currentSlide === totalSlides - 1) {
            nextArrow.style.display = 'none'; // Hide next arrow when on the last slide
        } else {
            nextArrow.style.display = 'grid'; // Show next arrow otherwise
        }
    }

    // Call updateArrowVisibility() once the page loads
    document.addEventListener("DOMContentLoaded", function () {
        updateArrowVisibility();
    });
</script>
{% endblock %}